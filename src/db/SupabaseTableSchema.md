
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.accounts */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.accounts (
  id bigint NOT NULL DEFAULT nextval('personal_finance.accounts_id_seq'::regclass),
  user_id uuid,
  country text NOT NULL,
  account_category text NOT NULL,
  provider_id bigint,
  account_number text,
  name text NOT NULL,
  currency text DEFAULT 'USD'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  balance real DEFAULT '0'::real,
  institution text,
  type text
);

-- PRIMARY KEY
ALTER TABLE personal_finance.accounts ADD CONSTRAINT accounts_pkey PRIMARY KEY (id);
-- FOREIGN KEY: accounts_user_id_fkey
ALTER TABLE personal_finance.accounts ADD CONSTRAINT accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: accounts_provider_id_fkey
ALTER TABLE personal_finance.accounts ADD CONSTRAINT accounts_provider_id_fkey FOREIGN KEY (provider_id) REFERENCES personal_finance.providers(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.accounts_id_seq */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.accounts_id_seq (
  last_value bigint NOT NULL,
  log_cnt bigint NOT NULL,
  is_called boolean NOT NULL
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.accounts_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.accounts_pkey (
  id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.belief_tags */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.belief_tags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  category_id uuid,
  inserted_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.belief_tags ADD CONSTRAINT belief_tags_pkey PRIMARY KEY (id);
-- FOREIGN KEY: belief_tags_category_id_fkey
ALTER TABLE personal_finance.belief_tags ADD CONSTRAINT belief_tags_category_id_fkey FOREIGN KEY (category_id) REFERENCES personal_finance.category(id);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.belief_tags_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.belief_tags_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.budgets */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.budgets (
  id bigint NOT NULL DEFAULT nextval('personal_finance.budgets_id_seq'::regclass),
  user_id uuid,
  category text NOT NULL,
  amount numeric NOT NULL,
  month integer NOT NULL,
  year integer NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.budgets ADD CONSTRAINT budgets_pkey PRIMARY KEY (id);
-- FOREIGN KEY: budgets_user_id_fkey
ALTER TABLE personal_finance.budgets ADD CONSTRAINT budgets_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.budgets_id_seq */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.budgets_id_seq (
  last_value bigint NOT NULL,
  log_cnt bigint NOT NULL,
  is_called boolean NOT NULL
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.budgets_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.budgets_pkey (
  id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.budgets_user_id_category_month_year_key */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.budgets_user_id_category_month_year_key (
  user_id uuid,
  category text,
  month integer,
  year integer
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.cash_transactions */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.cash_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  account_id uuid,
  transaction_date date NOT NULL,
  description text NOT NULL,
  transaction_type text NOT NULL,
  debit numeric(15,2) DEFAULT 0,
  credit numeric(15,2) DEFAULT 0,
  balance numeric(15,2),
  currency text NOT NULL DEFAULT 'CAD'::text,
  created_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.cash_transactions ADD CONSTRAINT cash_transactions_pkey PRIMARY KEY (id);
-- FOREIGN KEY: cash_transactions_account_id_fkey
ALTER TABLE personal_finance.cash_transactions ADD CONSTRAINT cash_transactions_account_id_fkey FOREIGN KEY (account_id) REFERENCES personal_finance.investment_accounts(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.cash_transactions_account_id_transaction_date_description_d_key */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.cash_transactions_account_id_transaction_date_description_d_key (
  account_id uuid,
  transaction_date date,
  description text,
  debit numeric(15,2),
  credit numeric(15,2)
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.cash_transactions_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.cash_transactions_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.category */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.category (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  is_split_enabled boolean DEFAULT false,
  inserted_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.category ADD CONSTRAINT category_pkey PRIMARY KEY (id);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.category_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.category_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.chart_of_accounts */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.chart_of_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  code text NOT NULL,
  name text NOT NULL,
  account_type text NOT NULL,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_active boolean
);

-- PRIMARY KEY
ALTER TABLE personal_finance.chart_of_accounts ADD CONSTRAINT chart_of_accounts_pkey PRIMARY KEY (id);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.chart_of_accounts_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.chart_of_accounts_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.column_mappings */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.column_mappings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_id bigint,
  file_type text NOT NULL,
  name text NOT NULL,
  mapping_config jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.column_mappings ADD CONSTRAINT column_mappings_pkey PRIMARY KEY (id);
-- FOREIGN KEY: column_mappings_user_id_fkey
ALTER TABLE personal_finance.column_mappings ADD CONSTRAINT column_mappings_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: column_mappings_account_id_fkey
ALTER TABLE personal_finance.column_mappings ADD CONSTRAINT column_mappings_account_id_fkey FOREIGN KEY (account_id) REFERENCES personal_finance.accounts(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.column_mappings_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.column_mappings_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.description_rules */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.description_rules (
  id bigint NOT NULL DEFAULT nextval('personal_finance.description_rules_id_seq'::regclass),
  user_id uuid,
  description_pattern text NOT NULL,
  chart_of_account text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.description_rules ADD CONSTRAINT description_rules_pkey PRIMARY KEY (id);
-- FOREIGN KEY: description_rules_user_id_fkey
ALTER TABLE personal_finance.description_rules ADD CONSTRAINT description_rules_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.description_rules_id_seq */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.description_rules_id_seq (
  last_value bigint NOT NULL,
  log_cnt bigint NOT NULL,
  is_called boolean NOT NULL
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.description_rules_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.description_rules_pkey (
  id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.goals */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.goals (
  id bigint NOT NULL DEFAULT nextval('personal_finance.goals_id_seq'::regclass),
  user_id uuid,
  name text NOT NULL,
  target_amount numeric NOT NULL,
  current_amount numeric DEFAULT 0,
  deadline date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.goals ADD CONSTRAINT goals_pkey PRIMARY KEY (id);
-- FOREIGN KEY: goals_user_id_fkey
ALTER TABLE personal_finance.goals ADD CONSTRAINT goals_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.goals_id_seq */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.goals_id_seq (
  last_value bigint NOT NULL,
  log_cnt bigint NOT NULL,
  is_called boolean NOT NULL
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.goals_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.goals_pkey (
  id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.holdings */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.holdings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  account_id uuid,
  symbol text NOT NULL,
  security_name text NOT NULL,
  units numeric(15,6) NOT NULL,
  price numeric(15,4) NOT NULL,
  market_value numeric(15,2) NOT NULL,
  book_value numeric(15,2),
  gain_loss numeric(15,2),
  as_of_date date NOT NULL,
  currency text NOT NULL DEFAULT 'CAD'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.holdings ADD CONSTRAINT holdings_pkey PRIMARY KEY (id);
-- FOREIGN KEY: holdings_account_id_fkey
ALTER TABLE personal_finance.holdings ADD CONSTRAINT holdings_account_id_fkey FOREIGN KEY (account_id) REFERENCES personal_finance.investment_accounts(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.holdings_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.holdings_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_accounts_provider_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_accounts_provider_id (
  provider_id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_accounts_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_accounts_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_budgets_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_budgets_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_cash_transactions_account_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_cash_transactions_account_id (
  account_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_cash_transactions_date */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_cash_transactions_date (
  transaction_date date
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_column_mappings_account_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_column_mappings_account_id (
  account_id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_column_mappings_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_column_mappings_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_description_rules_pattern */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_description_rules_pattern (
  description_pattern text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_description_rules_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_description_rules_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_goals_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_goals_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_holdings_account_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_holdings_account_id (
  account_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_holdings_symbol */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_holdings_symbol (
  symbol text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_import_raw_data_created_at */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_import_raw_data_created_at (
  created_at timestamp with time zone
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_import_raw_data_staging_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_import_raw_data_staging_id (
  staging_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_import_staging_account_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_import_staging_account_id (
  account_id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_import_staging_status */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_import_staging_status (
  status text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_import_staging_uploaded_at */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_import_staging_uploaded_at (
  uploaded_at timestamp with time zone
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_import_staging_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_import_staging_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_investment_accounts_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_investment_accounts_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_investment_transactions_account_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_investment_transactions_account_id (
  account_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_investment_transactions_date */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_investment_transactions_date (
  transaction_date date
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_investment_transactions_symbol */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_investment_transactions_symbol (
  symbol text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_merchant_aliases_gin */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_merchant_aliases_gin (
  aliases text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_merchant_normalized_name */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_merchant_normalized_name (
  normalized_name text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_merchant_normalized_name_lower */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_merchant_normalized_name_lower (
  lower text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_merchant_split_rules_name */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_merchant_split_rules_name (
  merchant_friendly_name text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_merchant_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_merchant_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_product_metadata_product_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_product_metadata_product_id (
  product_id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_products_account_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_products_account_id (
  account_id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_products_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_products_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_providers_country */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_providers_country (
  country text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_providers_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_providers_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_subscription_history_action_date */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_subscription_history_action_date (
  action_date timestamp with time zone
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_subscription_history_subscription_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_subscription_history_subscription_id (
  subscription_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_subscription_history_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_subscription_history_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_subscriptions_active */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_subscriptions_active (
  user_id uuid,
  is_active boolean
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_subscriptions_merchant_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_subscriptions_merchant_id (
  user_id uuid,
  merchant_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_subscriptions_next_billing */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_subscriptions_next_billing (
  user_id uuid,
  next_billing_date date
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_subscriptions_user_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_subscriptions_user_id (
  user_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_tax_withholdings_account_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_tax_withholdings_account_id (
  account_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_transaction_split_transaction_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_transaction_split_transaction_id (
  transaction_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_transactions_account_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_transactions_account_id (
  account_id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_transactions_category_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_transactions_category_id (
  account_id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_transactions_chart_of_account_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_transactions_chart_of_account_id (
  chart_of_account_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_transactions_date */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_transactions_date (
  date date
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_transactions_normalized_merchant_id */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_transactions_normalized_merchant_id (
  normalized_merchant_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_transactions_status */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_transactions_status (
  status text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_transactions_status_account */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_transactions_status_account (
  account_id bigint,
  status text,
  date date
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.idx_transactions_user_id_date */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.idx_transactions_user_id_date (
  user_id uuid,
  date date
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.import_raw_data */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.import_raw_data (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  staging_id uuid NOT NULL,
  raw_data jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.import_raw_data ADD CONSTRAINT import_raw_data_pkey PRIMARY KEY (id);
-- FOREIGN KEY: import_raw_data_staging_id_fkey
ALTER TABLE personal_finance.import_raw_data ADD CONSTRAINT import_raw_data_staging_id_fkey FOREIGN KEY (staging_id) REFERENCES personal_finance.import_staging(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.import_raw_data_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.import_raw_data_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.import_staging */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.import_staging (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_id bigint,
  file_name text NOT NULL,
  file_type text NOT NULL,
  column_names text[],
  row_count integer NOT NULL DEFAULT 0,
  status text NOT NULL DEFAULT 'pending_mapping'::text,
  mapping_id uuid,
  error_message text,
  uploaded_at timestamp with time zone DEFAULT now(),
  imported_at timestamp with time zone
);

-- PRIMARY KEY
ALTER TABLE personal_finance.import_staging ADD CONSTRAINT import_staging_pkey PRIMARY KEY (id);
-- FOREIGN KEY: import_staging_user_id_fkey
ALTER TABLE personal_finance.import_staging ADD CONSTRAINT import_staging_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: import_staging_account_id_fkey
ALTER TABLE personal_finance.import_staging ADD CONSTRAINT import_staging_account_id_fkey FOREIGN KEY (account_id) REFERENCES personal_finance.accounts(id) ON DELETE CASCADE;

-- FOREIGN KEY: import_staging_mapping_id_fkey
ALTER TABLE personal_finance.import_staging ADD CONSTRAINT import_staging_mapping_id_fkey FOREIGN KEY (mapping_id) REFERENCES personal_finance.column_mappings(id) ON DELETE SET NULL;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.import_staging_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.import_staging_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.investment_accounts */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.investment_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_number text NOT NULL,
  account_type text NOT NULL,
  institution text NOT NULL,
  currency text NOT NULL DEFAULT 'CAD'::text,
  opening_balance numeric(15,2),
  closing_balance numeric(15,2),
  statement_date date,
  statement_period text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.investment_accounts ADD CONSTRAINT investment_accounts_pkey PRIMARY KEY (id);
-- FOREIGN KEY: investment_accounts_user_id_fkey
ALTER TABLE personal_finance.investment_accounts ADD CONSTRAINT investment_accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.investment_accounts_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.investment_accounts_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.investment_accounts_user_id_account_number_institution_key */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.investment_accounts_user_id_account_number_institution_key (
  user_id uuid,
  account_number text,
  institution text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.investment_transactions */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.investment_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  account_id uuid,
  transaction_date date NOT NULL,
  symbol text,
  security_name text,
  transaction_type text NOT NULL,
  units numeric(15,6),
  price numeric(15,4),
  amount numeric(15,2) NOT NULL,
  fees numeric(15,2) DEFAULT 0,
  currency text NOT NULL DEFAULT 'CAD'::text,
  description text,
  created_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.investment_transactions ADD CONSTRAINT investment_transactions_pkey PRIMARY KEY (id);
-- FOREIGN KEY: investment_transactions_account_id_fkey
ALTER TABLE personal_finance.investment_transactions ADD CONSTRAINT investment_transactions_account_id_fkey FOREIGN KEY (account_id) REFERENCES personal_finance.investment_accounts(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.investment_transactions_account_id_transaction_date_symbol__key */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.investment_transactions_account_id_transaction_date_symbol__key (
  account_id uuid,
  transaction_date date,
  symbol text,
  transaction_type text,
  units numeric(15,6),
  amount numeric(15,2)
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.investment_transactions_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.investment_transactions_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.merchant */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.merchant (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  normalized_name text NOT NULL,
  category_id uuid,
  aliases text[],
  inserted_at timestamp with time zone DEFAULT now(),
  user_id uuid,
  is_big_box_store boolean DEFAULT false,
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.merchant ADD CONSTRAINT merchant_pkey PRIMARY KEY (id);
-- FOREIGN KEY: merchant_user_id_fkey
ALTER TABLE personal_finance.merchant ADD CONSTRAINT merchant_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: merchant_category_id_fkey
ALTER TABLE personal_finance.merchant ADD CONSTRAINT merchant_category_id_fkey FOREIGN KEY (category_id) REFERENCES personal_finance.category(id);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.merchant_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.merchant_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.merchant_split_rules */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.merchant_split_rules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  merchant_friendly_name text NOT NULL,
  splits jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.merchant_split_rules ADD CONSTRAINT merchant_split_rules_pkey PRIMARY KEY (id);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.merchant_split_rules_merchant_friendly_name_key */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.merchant_split_rules_merchant_friendly_name_key (
  merchant_friendly_name text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.merchant_split_rules_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.merchant_split_rules_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.product_metadata */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.product_metadata (
  id bigint NOT NULL DEFAULT nextval('personal_finance.product_metadata_id_seq'::regclass),
  user_id uuid,
  product_id bigint,
  key text NOT NULL,
  value text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.product_metadata ADD CONSTRAINT product_metadata_pkey PRIMARY KEY (id);
-- FOREIGN KEY: product_metadata_user_id_fkey
ALTER TABLE personal_finance.product_metadata ADD CONSTRAINT product_metadata_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: product_metadata_product_id_fkey
ALTER TABLE personal_finance.product_metadata ADD CONSTRAINT product_metadata_product_id_fkey FOREIGN KEY (product_id) REFERENCES personal_finance.products(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.product_metadata_id_seq */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.product_metadata_id_seq (
  last_value bigint NOT NULL,
  log_cnt bigint NOT NULL,
  is_called boolean NOT NULL
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.product_metadata_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.product_metadata_pkey (
  id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.product_metadata_product_id_key_key */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.product_metadata_product_id_key_key (
  product_id bigint,
  key text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.products */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.products (
  id bigint NOT NULL DEFAULT nextval('personal_finance.products_id_seq'::regclass),
  user_id uuid,
  account_id bigint,
  product_type text NOT NULL,
  product_name text NOT NULL,
  product_code text,
  quantity numeric DEFAULT 0,
  purchase_price numeric DEFAULT 0,
  current_price numeric DEFAULT 0,
  purchase_date date,
  maturity_date date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.products ADD CONSTRAINT products_pkey PRIMARY KEY (id);
-- FOREIGN KEY: products_user_id_fkey
ALTER TABLE personal_finance.products ADD CONSTRAINT products_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: products_account_id_fkey
ALTER TABLE personal_finance.products ADD CONSTRAINT products_account_id_fkey FOREIGN KEY (account_id) REFERENCES personal_finance.accounts(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.products_id_seq */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.products_id_seq (
  last_value bigint NOT NULL,
  log_cnt bigint NOT NULL,
  is_called boolean NOT NULL
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.products_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.products_pkey (
  id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.profiles */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.profiles (
  id uuid NOT NULL,
  email text,
  full_name text,
  role text DEFAULT 'user'::text,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

-- PRIMARY KEY
ALTER TABLE personal_finance.profiles ADD CONSTRAINT profiles_pkey PRIMARY KEY (id);
-- FOREIGN KEY: profiles_id_fkey
ALTER TABLE personal_finance.profiles ADD CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.profiles_email_key */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.profiles_email_key (
  email text
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.profiles_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.profiles_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.providers */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.providers (
  id bigint NOT NULL DEFAULT nextval('personal_finance.providers_id_seq'::regclass),
  user_id uuid,
  name text NOT NULL,
  country text NOT NULL,
  type text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.providers ADD CONSTRAINT providers_pkey PRIMARY KEY (id);
-- FOREIGN KEY: providers_user_id_fkey
ALTER TABLE personal_finance.providers ADD CONSTRAINT providers_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.providers_id_seq */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.providers_id_seq (
  last_value bigint NOT NULL,
  log_cnt bigint NOT NULL,
  is_called boolean NOT NULL
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.providers_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.providers_pkey (
  id bigint
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.subscription_history */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.subscription_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  subscription_id uuid NOT NULL,
  user_id uuid NOT NULL,
  action text NOT NULL,
  action_date timestamp with time zone NOT NULL DEFAULT now(),
  reason text,
  notes text,
  old_value text,
  new_value text
);

-- PRIMARY KEY
ALTER TABLE personal_finance.subscription_history ADD CONSTRAINT subscription_history_pkey PRIMARY KEY (id);
-- FOREIGN KEY: subscription_history_user_id_fkey
ALTER TABLE personal_finance.subscription_history ADD CONSTRAINT subscription_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: subscription_history_subscription_id_fkey
ALTER TABLE personal_finance.subscription_history ADD CONSTRAINT subscription_history_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES personal_finance.subscriptions(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.subscription_history_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.subscription_history_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.subscriptions */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  merchant_id uuid NOT NULL,
  friendly_name text NOT NULL,
  amount numeric(12,2) NOT NULL,
  currency text NOT NULL DEFAULT 'USD'::text,
  frequency text NOT NULL,
  next_billing_date date,
  last_billing_date date,
  billing_day_of_month integer,
  is_active boolean NOT NULL DEFAULT true,
  activated_at timestamp with time zone DEFAULT now(),
  deactivated_at timestamp with time zone,
  description text,
  reminder_days_before integer DEFAULT 3,
  auto_renew boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.subscriptions ADD CONSTRAINT subscriptions_pkey PRIMARY KEY (id);
-- FOREIGN KEY: subscriptions_user_id_fkey
ALTER TABLE personal_finance.subscriptions ADD CONSTRAINT subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: subscriptions_merchant_id_fkey
ALTER TABLE personal_finance.subscriptions ADD CONSTRAINT subscriptions_merchant_id_fkey FOREIGN KEY (merchant_id) REFERENCES personal_finance.merchant(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.subscriptions_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.subscriptions_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.tax_withholdings */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.tax_withholdings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  account_id uuid,
  transaction_id uuid,
  withholding_date date NOT NULL,
  symbol text,
  withholding_amount numeric(15,2) NOT NULL,
  country text NOT NULL,
  income_type text NOT NULL,
  currency text NOT NULL DEFAULT 'CAD'::text,
  created_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.tax_withholdings ADD CONSTRAINT tax_withholdings_pkey PRIMARY KEY (id);
-- FOREIGN KEY: tax_withholdings_account_id_fkey
ALTER TABLE personal_finance.tax_withholdings ADD CONSTRAINT tax_withholdings_account_id_fkey FOREIGN KEY (account_id) REFERENCES personal_finance.investment_accounts(id) ON DELETE CASCADE;

-- FOREIGN KEY: tax_withholdings_transaction_id_fkey
ALTER TABLE personal_finance.tax_withholdings ADD CONSTRAINT tax_withholdings_transaction_id_fkey FOREIGN KEY (transaction_id) REFERENCES personal_finance.investment_transactions(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.tax_withholdings_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.tax_withholdings_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.transaction_split */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.transaction_split (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  transaction_id uuid,
  category_id uuid,
  amount numeric(12,2) NOT NULL,
  percentage numeric(5,2),
  belief_tag text,
  chart_of_account_id uuid,
  inserted_at timestamp with time zone DEFAULT now(),
  description text,
  user_id uuid
);

-- PRIMARY KEY
ALTER TABLE personal_finance.transaction_split ADD CONSTRAINT transaction_split_pkey PRIMARY KEY (id);
-- FOREIGN KEY: transaction_split_category_id_fkey
ALTER TABLE personal_finance.transaction_split ADD CONSTRAINT transaction_split_category_id_fkey FOREIGN KEY (category_id) REFERENCES personal_finance.category(id);

-- FOREIGN KEY: transaction_split_chart_of_account_id_fkey
ALTER TABLE personal_finance.transaction_split ADD CONSTRAINT transaction_split_chart_of_account_id_fkey FOREIGN KEY (chart_of_account_id) REFERENCES personal_finance.chart_of_accounts(id);

-- FOREIGN KEY: transaction_split_transaction_id_fkey
ALTER TABLE personal_finance.transaction_split ADD CONSTRAINT transaction_split_transaction_id_fkey FOREIGN KEY (transaction_id) REFERENCES personal_finance.transactions(id) ON DELETE CASCADE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.transaction_split_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.transaction_split_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.transactions */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  date date NOT NULL,
  raw_merchant_name text NOT NULL,
  normalized_merchant_id uuid,
  amount numeric(12,2) NOT NULL,
  currency text NOT NULL,
  is_split boolean DEFAULT false,
  notes text,
  inserted_at timestamp with time zone DEFAULT now(),
  category_id uuid,
  description text,
  memo text,
  type text,
  account_id bigint,
  chart_of_account_id uuid,
  split_chart_of_account_id uuid,
  product_id uuid,
  status text DEFAULT 'pending_merchant_mapping'::text,
  updated_at timestamp with time zone DEFAULT now()
);

-- PRIMARY KEY
ALTER TABLE personal_finance.transactions ADD CONSTRAINT transactions_pkey PRIMARY KEY (id);
-- FOREIGN KEY: transactions_user_id_fkey
ALTER TABLE personal_finance.transactions ADD CONSTRAINT transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: transactions_account_id_fkey
ALTER TABLE personal_finance.transactions ADD CONSTRAINT transactions_account_id_fkey FOREIGN KEY (account_id) REFERENCES personal_finance.accounts(id) ON DELETE SET NULL;

-- FOREIGN KEY: transactions_category_id_fkey
ALTER TABLE personal_finance.transactions ADD CONSTRAINT transactions_category_id_fkey FOREIGN KEY (category_id) REFERENCES personal_finance.category(id) ON DELETE SET NULL;

-- FOREIGN KEY: transactions_chart_of_account_id_fkey
ALTER TABLE personal_finance.transactions ADD CONSTRAINT transactions_chart_of_account_id_fkey FOREIGN KEY (chart_of_account_id) REFERENCES personal_finance.chart_of_accounts(id) ON DELETE SET NULL;

-- FOREIGN KEY: transactions_split_chart_of_account_id_fkey
ALTER TABLE personal_finance.transactions ADD CONSTRAINT transactions_split_chart_of_account_id_fkey FOREIGN KEY (split_chart_of_account_id) REFERENCES personal_finance.chart_of_accounts(id) ON DELETE SET NULL;

-- FOREIGN KEY: transactions_normalized_merchant_id_fkey
ALTER TABLE personal_finance.transactions ADD CONSTRAINT transactions_normalized_merchant_id_fkey FOREIGN KEY (normalized_merchant_id) REFERENCES personal_finance.merchant(id); |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.transactions_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.transactions_pkey (
  id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.user_preferences */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.user_preferences (
  user_id uuid NOT NULL,
  merchant_id uuid NOT NULL,
  preferred_split_json jsonb,
  auto_tag_enabled boolean DEFAULT true
);

-- PRIMARY KEY
ALTER TABLE personal_finance.user_preferences ADD CONSTRAINT user_preferences_pkey PRIMARY KEY (user_id, merchant_id);
-- FOREIGN KEY: user_preferences_user_id_fkey
ALTER TABLE personal_finance.user_preferences ADD CONSTRAINT user_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- FOREIGN KEY: user_preferences_merchant_id_fkey
ALTER TABLE personal_finance.user_preferences ADD CONSTRAINT user_preferences_merchant_id_fkey FOREIGN KEY (merchant_id) REFERENCES personal_finance.merchant(id);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| /* ------------------------------------------------------------ */
/* TABLE: personal_finance.user_preferences_pkey */
/* ------------------------------------------------------------ */
CREATE TABLE personal_finance.user_preferences_pkey (
  user_id uuid,
  merchant_id uuid
);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |