| ddl                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| CREATE TABLE personal_finance.accounts (id bigint NOT NULL, type text, institution text, balance real, updated_at timestamp with time zone, created_at timestamp with time zone, currency text, name text NOT NULL, account_number text, provider_id bigint, account_category text NOT NULL, country text NOT NULL, user_id uuid);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| CREATE TABLE personal_finance.ai_extraction_logs (total_tokens integer, id uuid NOT NULL, user_id uuid, filename text NOT NULL, file_size integer, extraction_timestamp timestamp with time zone NOT NULL, model_used text NOT NULL, prompt_tokens integer, created_at timestamp with time zone, extraction_data jsonb NOT NULL, completion_tokens integer);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| CREATE TABLE personal_finance.belief_tags (inserted_at timestamp with time zone, category_id uuid, description text, name text NOT NULL, id uuid NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| CREATE TABLE personal_finance.budgets (year integer NOT NULL, month integer NOT NULL, amount numeric NOT NULL, category text NOT NULL, user_id uuid, id bigint NOT NULL, updated_at timestamp with time zone, created_at timestamp with time zone);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| CREATE TABLE personal_finance.cash_transactions (debit numeric, id uuid NOT NULL, created_at timestamp with time zone, currency text NOT NULL, balance numeric, credit numeric, account_id uuid, transaction_date date NOT NULL, description text NOT NULL, transaction_type text NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| CREATE TABLE personal_finance.category (description text, id uuid NOT NULL, name text NOT NULL, inserted_at timestamp with time zone, is_split_enabled boolean);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| CREATE TABLE personal_finance.chart_of_accounts (created_at timestamp with time zone, user_id uuid NOT NULL, code text NOT NULL, is_active boolean, updated_at timestamp with time zone, id uuid NOT NULL, description text, name text NOT NULL, account_type text NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| CREATE TABLE personal_finance.column_mappings (account_id bigint, created_at timestamp with time zone, updated_at timestamp with time zone, file_type text NOT NULL, mapping_config jsonb NOT NULL, user_id uuid, id uuid NOT NULL, name text NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| CREATE TABLE personal_finance.description_rules (updated_at timestamp with time zone, created_at timestamp with time zone, description_pattern text NOT NULL, chart_of_account text NOT NULL, user_id uuid, id bigint NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| CREATE TABLE personal_finance.goals (created_at timestamp with time zone, id bigint NOT NULL, user_id uuid, name text NOT NULL, target_amount numeric NOT NULL, current_amount numeric, deadline date, updated_at timestamp with time zone);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| CREATE TABLE personal_finance.government_benefits (cpp_at_60 numeric, pension_normal_age integer, pension_current_value numeric, spouse_cpp_at_65 numeric, spouse_oas_estimated numeric, spouse_pension_estimated numeric, last_updated date, created_at timestamp with time zone, id uuid NOT NULL, user_id uuid NOT NULL, cpp_estimated_at_65 numeric, cpp_statement_date date, cpp_contributions_to_date numeric, cpp_years_contributed integer, pension_earliest_age integer, pension_estimated_monthly numeric, pension_best_average_salary numeric, pension_multiplier numeric, pension_years_of_service numeric, pension_employer text, pension_type text, has_employer_pension boolean, gis_estimated_monthly numeric, gis_eligible boolean, oas_clawback_threshold numeric, oas_planned_start_age integer, oas_eligible_age integer, oas_years_in_canada integer, oas_estimated_monthly numeric, cpp_planned_start_age integer, cpp_at_70 numeric, cpp_at_65 numeric); |
| CREATE TABLE personal_finance.holding_snapshots (book_cost numeric, id uuid NOT NULL, user_id uuid, account_id uuid, symbol text NOT NULL, security_name text, snapshot_date date NOT NULL, units numeric NOT NULL, unit_price numeric NOT NULL, market_value numeric NOT NULL, unrealized_gain_loss numeric, gain_loss_percentage numeric, units_change numeric, value_change numeric, source text, created_at timestamp with time zone);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| CREATE TABLE personal_finance.holdings (symbol text NOT NULL, units numeric NOT NULL, price numeric NOT NULL, market_value numeric NOT NULL, book_value numeric, gain_loss numeric, as_of_date date NOT NULL, currency text NOT NULL, created_at timestamp with time zone, updated_at timestamp with time zone, asset_type text, category text, exchange text, average_cost_per_unit numeric, account_type text, institution text, id uuid NOT NULL, sub_category text, user_id uuid, investment_type text, sector text, geography text, account_id uuid, security_name text NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                         |
| CREATE TABLE personal_finance.import_raw_data (raw_data jsonb NOT NULL, created_at timestamp with time zone, id uuid NOT NULL, staging_id uuid NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| CREATE TABLE personal_finance.import_staging (row_count integer NOT NULL, id uuid NOT NULL, user_id uuid, account_id bigint, file_name text NOT NULL, file_type text NOT NULL, column_names ARRAY, status text NOT NULL, mapping_id uuid, error_message text, uploaded_at timestamp with time zone, imported_at timestamp with time zone);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| CREATE TABLE personal_finance.investment_accounts (institution text NOT NULL, id uuid NOT NULL, account_type text NOT NULL, display_name text, manager_id uuid, updated_at timestamp with time zone, created_at timestamp with time zone, statement_period text, statement_date date, closing_balance numeric, opening_balance numeric, currency text NOT NULL, account_number text NOT NULL, user_id uuid);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| CREATE TABLE personal_finance.investment_managers (created_at timestamp with time zone, contact_phone text, contact_email text, contact_name text, website text, description text, manager_type text NOT NULL, name text NOT NULL, user_id uuid, id uuid NOT NULL, updated_at timestamp with time zone);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| CREATE TABLE personal_finance.investment_transactions (account_id uuid, created_at timestamp with time zone, description text, currency text NOT NULL, fees numeric, amount numeric NOT NULL, price numeric, units numeric, transaction_type text NOT NULL, id uuid NOT NULL, security_name text, symbol text, transaction_date date NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| CREATE TABLE personal_finance.merchant (id uuid NOT NULL, aliases ARRAY, inserted_at timestamp with time zone, user_id uuid, is_big_box_store boolean, updated_at timestamp with time zone, normalized_name text NOT NULL, category_id uuid);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| CREATE TABLE personal_finance.merchant_split_rules (created_at timestamp with time zone, splits jsonb NOT NULL, merchant_friendly_name text NOT NULL, id uuid NOT NULL, updated_at timestamp with time zone);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| CREATE TABLE personal_finance.product_metadata (value text, key text NOT NULL, product_id bigint, user_id uuid, id bigint NOT NULL, updated_at timestamp with time zone, created_at timestamp with time zone);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| CREATE TABLE personal_finance.products (maturity_date date, id bigint NOT NULL, purchase_price numeric, quantity numeric, product_code text, product_name text NOT NULL, product_type text NOT NULL, user_id uuid, account_id bigint, created_at timestamp with time zone, updated_at timestamp with time zone, current_price numeric, purchase_date date);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| CREATE TABLE personal_finance.profiles (id uuid NOT NULL, email text, full_name text, role text, created_at timestamp with time zone);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| CREATE TABLE personal_finance.providers (name text NOT NULL, type text NOT NULL, created_at timestamp with time zone, updated_at timestamp with time zone, id bigint NOT NULL, user_id uuid, country text NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| CREATE TABLE personal_finance.subscription_history (action text NOT NULL, id uuid NOT NULL, user_id uuid NOT NULL, subscription_id uuid NOT NULL, new_value text, old_value text, notes text, reason text, action_date timestamp with time zone NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| CREATE TABLE personal_finance.subscriptions (updated_at timestamp with time zone, created_at timestamp with time zone, auto_renew boolean, reminder_days_before integer, description text, deactivated_at timestamp with time zone, activated_at timestamp with time zone, is_active boolean NOT NULL, billing_day_of_month integer, last_billing_date date, next_billing_date date, frequency text NOT NULL, currency text NOT NULL, amount numeric NOT NULL, friendly_name text NOT NULL, merchant_id uuid NOT NULL, user_id uuid NOT NULL, id uuid NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                |
| CREATE TABLE personal_finance.tax_withholdings (symbol text, withholding_date date NOT NULL, transaction_id uuid, account_id uuid, created_at timestamp with time zone, id uuid NOT NULL, currency text NOT NULL, income_type text NOT NULL, country text NOT NULL, withholding_amount numeric NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| CREATE TABLE personal_finance.transaction_split (belief_tag text, percentage numeric, amount numeric NOT NULL, category_id uuid, transaction_id uuid, id uuid NOT NULL, user_id uuid, description text, inserted_at timestamp with time zone, chart_of_account_id uuid);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| CREATE TABLE personal_finance.transactions (normalized_merchant_id uuid, updated_at timestamp with time zone, status text, product_id uuid, split_chart_of_account_id uuid, chart_of_account_id uuid, account_id bigint, type text, memo text, description text, category_id uuid, inserted_at timestamp with time zone, notes text, is_split boolean, currency text NOT NULL, amount numeric NOT NULL, raw_merchant_name text NOT NULL, date date NOT NULL, user_id uuid, id uuid NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| CREATE TABLE personal_finance.user_preferences (user_id uuid NOT NULL, merchant_id uuid NOT NULL, preferred_split_json jsonb, auto_tag_enabled boolean);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| CREATE TABLE personal_finance.user_profile (id uuid NOT NULL, user_id uuid NOT NULL, date_of_birth date, province text, country text, marital_status text, spouse_date_of_birth date, employment_status text, current_annual_income numeric, spouse_annual_income numeric, expected_retirement_age integer, desired_retirement_income numeric, life_expectancy integer, marginal_tax_rate numeric, average_tax_rate numeric, rrsp_contribution_room numeric, rrsp_unused_room numeric, tfsa_contribution_room numeric, risk_tolerance text, preferred_currency text, created_at timestamp with time zone, updated_at timestamp with time zone);                                                                                                                                                                                                                                                                                                                                 |